on: [push, pull_request]

name: Render and Publish

permissions:
    contents: write
    pages: write

jobs:
    codespell:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - uses: codespell-project/actions-codespell@master

    build:
        runs-on: ubuntu-latest
        steps:

            - uses: actions/checkout@v4
            - uses: awalsh128/cache-apt-pkgs-action@latest
              with:
                packages: libssl-dev

            - uses: r-lib/actions/setup-r@v2
            - uses : r-lib/actions/setup-pandoc@v1
              with:
                r-version: '4.1.0'
                pandoc-version: '2.14'

            - name: Build the poster
              run: make install && make all && mkdir website && mv poster.html website/index.html && touch website/.nojekyll

            - name: Upload PDF
              uses: actions/upload-artifact@v1
              with:
                name: poster
                path: poster.pdf

    deploy:
      needs: build
      runs-on: ubuntu-latest
      on:
        pull_request:
          - types: [closed]
      if: github.event.pull_request.merged == true
      steps:
            - name: Commit poster PDF
              uses: EndBug/add-and-commit@v9
              with:
                add: 'poster.pdf'
                author_name: 'GitHub Actions'
                message: 'Add poster.pdf at ${{ github.sha }}'

            - name: Deploy html to gh-pages
              uses: JamesIves/github-pages-deploy-action@4.1.5
              with:
                branch: gh-pages
                folder: ${{github.workspace}}/website